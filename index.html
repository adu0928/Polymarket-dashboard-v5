<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket æ•°æ®çœ‹æ¿ Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%); min-height: 100vh; color: #fff; }
        .container { max-width: 1450px; margin: 0 auto; padding: 16px; }
        
        .header { position: sticky; top: 0; z-index: 100; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(55, 65, 81, 0.3); padding: 12px 0; margin-bottom: 16px; }
        .header-content { max-width: 1450px; margin: 0 auto; padding: 0 16px; }
        .header-top { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; flex-wrap: wrap; }
        .logo { width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, #06b6d4, #8b5cf6); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .title { font-size: 18px; font-weight: 700; background: linear-gradient(135deg, #06b6d4, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .subtitle { font-size: 9px; color: #6b7280; }
        .status-badge { margin-left: auto; display: flex; align-items: center; gap: 5px; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; }
        .status-dot.loading { background: #f59e0b; animation: pulse 1s infinite; }
        .status-dot.online { background: #10b981; }
        .status-dot.error { background: #ef4444; }
        @keyframes pulse { 0%,100%{opacity:1}50%{opacity:0.5} }
        .status-text { font-size: 9px; color: #9ca3af; }
        
        .tabs { display: flex; gap: 3px; flex-wrap: wrap; }
        .tab { padding: 7px 14px; font-size: 12px; font-weight: 500; border-radius: 5px; border: none; cursor: pointer; background: transparent; color: #9ca3af; transition: all 0.2s; }
        .tab:hover { background: rgba(31, 41, 55, 0.5); }
        .tab.active { background: #1f2937; color: #06b6d4; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; margin-bottom: 14px; }
        .stat-card { background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(17, 24, 39, 0.8)); border: 1px solid rgba(6, 182, 212, 0.3); border-radius: 8px; padding: 10px; }
        .stat-card.purple { background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(17, 24, 39, 0.8)); border-color: rgba(139, 92, 246, 0.3); }
        .stat-card.green { background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(17, 24, 39, 0.8)); border-color: rgba(16, 185, 129, 0.3); }
        .stat-card.orange { background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(17, 24, 39, 0.8)); border-color: rgba(245, 158, 11, 0.3); }
        .stat-card.pink { background: linear-gradient(135deg, rgba(236, 72, 153, 0.1), rgba(17, 24, 39, 0.8)); border-color: rgba(236, 72, 153, 0.3); }
        .stat-card.blue { background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(17, 24, 39, 0.8)); border-color: rgba(59, 130, 246, 0.3); }
        .stat-label { color: #9ca3af; font-size: 8px; text-transform: uppercase; margin-bottom: 2px; }
        .stat-value { color: #fff; font-size: 13px; font-weight: 700; font-family: monospace; }
        .stat-sub { color: #6b7280; font-size: 7px; margin-top: 1px; }
        
        .section { background: rgba(17, 24, 39, 0.6); border: 1px solid rgba(55, 65, 81, 0.5); border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .section-title { color: #fff; font-size: 11px; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        
        .bar-chart { display: flex; flex-direction: column; gap: 3px; }
        .bar-item { display: flex; align-items: center; gap: 4px; }
        .bar-label { color: #9ca3af; font-size: 8px; min-width: 65px; }
        .bar-container { flex: 1; height: 12px; background: rgba(55, 65, 81, 0.3); border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; border-radius: 2px; display: flex; align-items: center; justify-content: flex-end; padding-right: 3px; min-width: 14px; }
        .bar-pct { color: #fff; font-size: 7px; font-weight: 600; }
        .bar-value { color: #fff; font-size: 8px; font-family: monospace; min-width: 55px; text-align: right; }
        
        .h-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(70px, 1fr)); gap: 5px; }
        .h-stat { background: rgba(31,41,55,0.5); border-radius: 5px; padding: 6px; text-align: center; }
        .h-stat-label { color: #6b7280; font-size: 7px; margin-bottom: 1px; }
        .h-stat-value { color: #fff; font-size: 10px; font-weight: 600; font-family: monospace; }
        .h-stat-value.green { color: #10b981; }
        .h-stat-value.red { color: #ef4444; }
        
        .table-container { background: rgba(17, 24, 39, 0.6); border: 1px solid rgba(55, 65, 81, 0.5); border-radius: 8px; overflow: hidden; }
        .table-scroll { overflow-x: auto; max-height: 480px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { position: sticky; top: 0; text-align: left; color: #9ca3af; font-size: 8px; font-weight: 500; padding: 7px 4px; background: rgba(31, 41, 55, 0.98); text-transform: uppercase; z-index: 10; white-space: nowrap; }
        th.right { text-align: right; }
        td { padding: 5px 4px; border-top: 1px solid rgba(55, 65, 81, 0.3); font-size: 9px; white-space: nowrap; }
        tr:hover { background: rgba(31, 41, 55, 0.3); }
        .market-title { display: flex; align-items: center; gap: 3px; max-width: 200px; }
        .market-icon { font-size: 9px; }
        .market-name { color: #fff; font-size: 9px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .category-tag { font-size: 7px; padding: 1px 3px; border-radius: 3px; background: rgba(139, 92, 246, 0.15); color: #a78bfa; }
        .price { font-family: monospace; font-size: 9px; font-weight: 600; }
        .price.high { color: #10b981; }
        .price.low { color: #ef4444; }
        .price.mid { color: #f59e0b; }
        .spread { font-family: monospace; font-size: 8px; padding: 1px 3px; border-radius: 2px; }
        .spread.profit { background: rgba(16,185,129,0.15); color: #10b981; }
        .spread.zero { background: rgba(107,114,128,0.15); color: #9ca3af; }
        .spread.low { background: rgba(245,158,11,0.15); color: #f59e0b; }
        .spread.high { background: rgba(239,68,68,0.15); color: #ef4444; }
        .mono { font-family: monospace; font-size: 8px; color: #d1d5db; text-align: right; }
        .status-tag { font-size: 7px; padding: 1px 3px; border-radius: 2px; }
        .status-tag.active { background: rgba(16,185,129,0.15); color: #10b981; }
        .status-tag.ended { background: rgba(107,114,128,0.2); color: #9ca3af; }
        
        .filters { background: rgba(17, 24, 39, 0.6); border: 1px solid rgba(55, 65, 81, 0.5); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 5px; }
        .filter-group label { display: block; color: #9ca3af; font-size: 7px; margin-bottom: 1px; }
        .filter-group select, .filter-group input { width: 100%; background: #1f2937; border: 1px solid #374151; border-radius: 3px; padding: 4px; color: #fff; font-size: 9px; outline: none; }
        .results-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; flex-wrap: wrap; gap: 5px; }
        .results-count { color: #9ca3af; font-size: 9px; }
        .results-count span { color: #06b6d4; font-weight: 600; }
        .refresh-btn { padding: 3px 8px; background: #1f2937; border: 1px solid #374151; border-radius: 3px; color: #9ca3af; font-size: 8px; cursor: pointer; }
        .refresh-btn:hover { background: #374151; color: #fff; }
        
        .lookup-container { background: rgba(17, 24, 39, 0.6); border: 1px solid rgba(55, 65, 81, 0.5); border-radius: 8px; padding: 14px; }
        .lookup-form { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .lookup-input { flex: 1; min-width: 220px; background: #1f2937; border: 1px solid #374151; border-radius: 6px; padding: 8px; color: #fff; font-size: 10px; font-family: monospace; outline: none; }
        .lookup-btn { padding: 8px 14px; background: linear-gradient(135deg, #8b5cf6, #ec4899); color: #fff; border: none; border-radius: 6px; font-size: 10px; font-weight: 600; cursor: pointer; }
        .lookup-btn:disabled { opacity: 0.5; }
        
        .info-box { padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: 9px; line-height: 1.4; }
        .info-box.info { background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.3); color: #06b6d4; }
        .info-box.success { background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981; }
        .info-box.warning { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); color: #f59e0b; }
        .info-box.error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; }
        .info-box a { color: #06b6d4; }
        
        .user-header { display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .user-avatar { font-size: 16px; }
        .user-address { color: #fff; font-size: 9px; font-family: monospace; word-break: break-all; }
        .user-links { margin-left: auto; display: flex; gap: 4px; flex-wrap: wrap; }
        .user-links a { color: #06b6d4; font-size: 8px; text-decoration: none; padding: 2px 4px; background: rgba(6,182,212,0.1); border-radius: 3px; }
        
        .user-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 6px; margin-bottom: 10px; }
        .user-stat-card { background: rgba(31, 41, 55, 0.5); border-radius: 6px; padding: 8px; }
        .user-stat-label { color: #9ca3af; font-size: 7px; margin-bottom: 1px; }
        .user-stat-value { font-size: 11px; font-weight: 700; font-family: monospace; }
        
        .history-section { background: rgba(31, 41, 55, 0.3); border-radius: 6px; padding: 8px; margin-top: 10px; }
        .history-title { color: #9ca3af; font-size: 9px; text-transform: uppercase; margin-bottom: 6px; display: flex; justify-content: space-between; }
        .history-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(55, 65, 81, 0.3); flex-wrap: wrap; gap: 4px; font-size: 8px; }
        .history-item:last-child { border-bottom: none; }
        .history-type { padding: 1px 4px; border-radius: 2px; font-size: 7px; }
        .history-type.buy { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .history-type.sell { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .history-market { color: #fff; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }
        .history-data { display: flex; gap: 10px; }
        .history-amount { color: #d1d5db; font-family: monospace; }
        .history-date { color: #6b7280; font-size: 7px; }
        
        .position-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(55, 65, 81, 0.3); flex-wrap: wrap; gap: 4px; }
        .position-item:last-child { border-bottom: none; }
        .position-left { display: flex; align-items: center; gap: 4px; flex: 1; min-width: 150px; }
        .position-outcome { font-size: 6px; padding: 1px 3px; border-radius: 2px; }
        .position-outcome.yes { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .position-outcome.no { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .position-market { color: #fff; font-size: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 150px; }
        .position-right { display: flex; gap: 6px; }
        .position-data { text-align: right; min-width: 35px; }
        .position-data-label { color: #6b7280; font-size: 6px; }
        .position-data-value { color: #fff; font-size: 8px; font-family: monospace; }
        .position-data-value.green { color: #10b981; }
        .position-data-value.red { color: #ef4444; }
        
        .empty-state { text-align: center; padding: 25px; color: #6b7280; }
        
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .loading-content { text-align: center; }
        .loading-spinner { width: 35px; height: 35px; border: 3px solid rgba(6,182,212,0.3); border-top-color: #06b6d4; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: #9ca3af; font-size: 11px; }
        .loading-sub { color: #6b7280; font-size: 9px; margin-top: 4px; }
        
        .footer { margin-top: 16px; padding: 10px; border-top: 1px solid rgba(55, 65, 81, 0.3); }
        .footer-content { max-width: 1450px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 6px; }
        .footer-text { color: #6b7280; font-size: 8px; }
        .footer-links { display: flex; gap: 10px; }
        .footer-links a { color: #9ca3af; font-size: 8px; text-decoration: none; }
        
        .pagination { display: flex; justify-content: center; gap: 3px; margin-top: 8px; flex-wrap: wrap; }
        .pagination button { padding: 3px 6px; background: #1f2937; border: 1px solid #374151; border-radius: 3px; color: #fff; font-size: 8px; cursor: pointer; }
        .pagination button:disabled { opacity: 0.5; }
        .pagination button.active { background: #06b6d4; border-color: #06b6d4; }
        
        .spin { display: inline-block; width: 8px; height: 8px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 4px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loading-text">æ­£åœ¨ä» Polymarket API åŠ è½½æ•°æ®...</div>
            <div class="loading-sub" id="loading-sub">é¦–æ¬¡åŠ è½½å¯èƒ½éœ€è¦ 10-30 ç§’</div>
        </div>
    </div>

    <header class="header">
        <div class="header-content">
            <div class="header-top">
                <div class="logo">ğŸŒ</div>
                <div>
                    <h1 class="title">Polymarket æ•°æ®çœ‹æ¿ Pro</h1>
                    <p class="subtitle">å®æ—¶APIæ•°æ® Â· polymarket.com Â· polygonscan.com</p>
                </div>
                <div class="status-badge">
                    <div class="status-dot loading" id="status-dot"></div>
                    <span class="status-text" id="status-text">åŠ è½½ä¸­...</span>
                </div>
            </div>
            <div class="tabs">
                <button class="tab active" onclick="showTab('overview')">ğŸ“Š æ€»è§ˆ</button>
                <button class="tab" onclick="showTab('markets')">ğŸ¯ å¸‚åœºåˆ—è¡¨</button>
                <button class="tab" onclick="showTab('users')">ğŸ‘¥ ç”¨æˆ·åˆ†æ</button>
                <button class="tab" onclick="showTab('address')">ğŸ” åœ°å€æŸ¥è¯¢</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="overview" class="tab-content active"></div>
        <div id="markets" class="tab-content"></div>
        <div id="users" class="tab-content"></div>
        <div id="address" class="tab-content"></div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">æ•°æ®æ¥æº: Polymarket Gamma API + Polygonscan Â· <span id="update-time">-</span></p>
            <div class="footer-links">
                <a href="https://polymarket.com" target="_blank">Polymarket â†—</a>
                <a href="https://polygonscan.com" target="_blank">Polygonscan â†—</a>
            </div>
        </div>
    </footer>

    <script>
// ============ å…¨å±€æ•°æ® ============
let allMarkets = [];
let filteredMarkets = [];
let marketStats = {};
let page = 1;
const pageSize = 30;

// ============ å·¥å…·å‡½æ•° ============
const fmt = n => (n === null || n === undefined || isNaN(n)) ? '0' : Math.floor(n).toLocaleString('en-US');
const fmtUSD = n => '$' + fmt(n);
const fmtPct = n => (n >= 0 ? '+' : '') + n.toFixed(2) + '%';
const fmtDate = d => d ? new Date(d).toLocaleDateString('zh-CN', {year:'numeric',month:'short',day:'numeric'}) : '-';
const fmtDateTime = d => d ? new Date(d).toLocaleString('zh-CN') : '-';
const getIcon = c => ({Politics:'ğŸ›ï¸',Crypto:'â‚¿',Sports:'âš½',Business:'ğŸ’¼',Entertainment:'ğŸ¬',Science:'ğŸ”¬',Other:'ğŸ”®'}[c]||'ğŸ”®');

function setStatus(status, text) {
    document.getElementById('status-dot').className = 'status-dot ' + status;
    document.getElementById('status-text').textContent = text;
}

function setLoading(show, text, sub) {
    document.getElementById('loading').style.display = show ? 'flex' : 'none';
    if (text) document.getElementById('loading-text').textContent = text;
    if (sub) document.getElementById('loading-sub').textContent = sub;
}

// ============ åŠ è½½æ•°æ® ============
async function loadAllData() {
    setLoading(true, 'æ­£åœ¨ä» Polymarket API è·å–å…¨éƒ¨å¸‚åœº...', 'é¢„è®¡éœ€è¦ 10-30 ç§’');
    setStatus('loading', 'åŠ è½½ä¸­...');
    
    try {
        const response = await fetch('/api/markets');
        if (!response.ok) throw new Error(`APIè¿”å› ${response.status}`);
        
        const data = await response.json();
        if (!data.success) throw new Error(data.error || 'APIå¤±è´¥');
        
        allMarkets = data.markets;
        marketStats = data.stats;
        
        renderOverview();
        renderMarketsPage();
        renderUsersPage();
        renderAddressPage();
        
        setStatus('online', `å·²åŠ è½½ ${allMarkets.length} ä¸ªå¸‚åœº`);
        document.getElementById('update-time').textContent = 'æ›´æ–°: ' + new Date().toLocaleString('zh-CN');
        
    } catch (error) {
        console.error('Load error:', error);
        setStatus('error', 'åŠ è½½å¤±è´¥');
        document.getElementById('overview').innerHTML = `
            <div class="info-box error">
                <strong>âŒ æ•°æ®åŠ è½½å¤±è´¥</strong><br>é”™è¯¯: ${error.message}<br><br>
                <button onclick="location.reload()" style="padding:6px 12px;background:#1f2937;border:1px solid #374151;border-radius:4px;color:#fff;cursor:pointer;">ç‚¹å‡»é‡è¯•</button>
            </div>
        `;
    }
    
    setLoading(false);
}

// ============ æ¸²æŸ“æ€»è§ˆ ============
function renderOverview() {
    const S = marketStats;
    const catStats = S.categoryStats || {};
    
    // è®¡ç®—ç±»åˆ«å æ¯”
    const catVolumeArr = Object.entries(catStats)
        .map(([name, data]) => ({ name, icon: getIcon(name), ...data, pct: (data.volume / S.totalVolume * 100).toFixed(1) }))
        .sort((a, b) => b.volume - a.volume);
    
    const catCountArr = Object.entries(catStats)
        .map(([name, data]) => ({ name, icon: getIcon(name), ...data, pct: (data.count / S.totalMarkets * 100).toFixed(1) }))
        .sort((a, b) => b.count - a.count);
    
    // ä¼°ç®—LPå¥–åŠ± (çº¦0.1%çš„æˆäº¤é‡)
    const lpRewards = S.totalVolume * 0.001;
    
    document.getElementById('overview').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">å†å²æ€»æˆäº¤é‡</div><div class="stat-value">${fmtUSD(S.totalVolume)}</div><div class="stat-sub">APIå®æ—¶</div></div>
            <div class="stat-card purple"><div class="stat-label">24hæˆäº¤é‡</div><div class="stat-value">${fmtUSD(S.volume24h)}</div><div class="stat-sub">APIå®æ—¶</div></div>
            <div class="stat-card green"><div class="stat-label">æ´»è·ƒå¸‚åœº</div><div class="stat-value">${fmt(S.activeMarkets)}</div><div class="stat-sub">è¿›è¡Œä¸­</div></div>
            <div class="stat-card orange"><div class="stat-label">å·²ç»“ç®—å¸‚åœº</div><div class="stat-value">${fmt(S.closedMarkets)}</div><div class="stat-sub">å†å²</div></div>
            <div class="stat-card pink"><div class="stat-label">æ€»å¸‚åœºæ•°</div><div class="stat-value">${fmt(S.totalMarkets)}</div><div class="stat-sub">APIè·å–</div></div>
            <div class="stat-card blue"><div class="stat-label">å¹³å°TVL</div><div class="stat-value">${fmtUSD(S.totalLiquidity)}</div><div class="stat-sub">æ€»æµåŠ¨æ€§</div></div>
            <div class="stat-card"><div class="stat-label">å¹³å‡ç£¨æŸ</div><div class="stat-value">${S.avgSpread.toFixed(2)}%</div><div class="stat-sub">æ´»è·ƒå¸‚åœº</div></div>
            <div class="stat-card purple"><div class="stat-label">LPå¥–åŠ±ç´¯è®¡(ä¼°)</div><div class="stat-value">${fmtUSD(lpRewards)}</div><div class="stat-sub">â‰ˆ0.1%æˆäº¤é‡</div></div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;">
            <div class="section"><div class="section-title">ğŸ“Š æˆäº¤é‡ç±»åˆ«åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(catVolumeArr.map(d=>({l:`${d.icon} ${d.name}`,v:fmtUSD(d.volume),p:parseFloat(d.pct)})))}</div></div>
            <div class="section"><div class="section-title">ğŸ¯ å¸‚åœºæ•°é‡åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(catCountArr.map(d=>({l:`${d.icon} ${d.name}`,v:fmt(d.count),p:parseFloat(d.pct)})))}</div></div>
            <div class="section"><div class="section-title">ğŸ“ˆ ç£¨æŸ/å¥—åˆ©åˆ†å¸ƒ</div><div class="bar-chart">${renderBar([
                {l:'ğŸŸ¢ å¥—åˆ©æœºä¼š(<0%)',v:fmt(S.spreadDistribution?.negative||0),p:(S.spreadDistribution?.negative||0)/S.activeMarkets*100},
                {l:'âšª æ— ç£¨æŸ(0-0.5%)',v:fmt(S.spreadDistribution?.zero||0),p:(S.spreadDistribution?.zero||0)/S.activeMarkets*100},
                {l:'ğŸŸ¡ ä½ç£¨æŸ(0.5-2%)',v:fmt(S.spreadDistribution?.low||0),p:(S.spreadDistribution?.low||0)/S.activeMarkets*100},
                {l:'ğŸŸ  ä¸­ç£¨æŸ(2-5%)',v:fmt(S.spreadDistribution?.medium||0),p:(S.spreadDistribution?.medium||0)/S.activeMarkets*100},
                {l:'ğŸ”´ é«˜ç£¨æŸ(>5%)',v:fmt(S.spreadDistribution?.high||0),p:(S.spreadDistribution?.high||0)/S.activeMarkets*100}
            ])}</div></div>
            <div class="section"><div class="section-title">ğŸ’° 24hæˆäº¤ç±»åˆ«åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(catVolumeArr.map(d=>({l:`${d.icon} ${d.name}`,v:fmtUSD(d.volume24h),p:d.volume24h/S.volume24h*100})))}</div></div>
        </div>
        
        <div class="section"><div class="section-title">ğŸ“ˆ äº¤æ˜“ç»Ÿè®¡è¯¦æƒ… (APIå®æ—¶æ•°æ®)</div><div class="h-stats">
            <div class="h-stat"><div class="h-stat-label">æ€»å¸‚åœºæ•°</div><div class="h-stat-value">${fmt(S.totalMarkets)}</div></div>
            <div class="h-stat"><div class="h-stat-label">æ´»è·ƒå¸‚åœº</div><div class="h-stat-value green">${fmt(S.activeMarkets)}</div></div>
            <div class="h-stat"><div class="h-stat-label">å·²ç»“ç®—</div><div class="h-stat-value">${fmt(S.closedMarkets)}</div></div>
            <div class="h-stat"><div class="h-stat-label">æ€»æˆäº¤é‡</div><div class="h-stat-value">${fmtUSD(S.totalVolume)}</div></div>
            <div class="h-stat"><div class="h-stat-label">24hæˆäº¤</div><div class="h-stat-value">${fmtUSD(S.volume24h)}</div></div>
            <div class="h-stat"><div class="h-stat-label">æ€»TVL</div><div class="h-stat-value">${fmtUSD(S.totalLiquidity)}</div></div>
            <div class="h-stat"><div class="h-stat-label">å¹³å‡æ¯å¸‚åœºæˆäº¤</div><div class="h-stat-value">${fmtUSD(S.totalVolume/S.totalMarkets)}</div></div>
            <div class="h-stat"><div class="h-stat-label">å¹³å‡æµåŠ¨æ€§</div><div class="h-stat-value">${fmtUSD(S.totalLiquidity/S.activeMarkets)}</div></div>
            <div class="h-stat"><div class="h-stat-label">å¹³å‡ç£¨æŸ</div><div class="h-stat-value">${S.avgSpread.toFixed(2)}%</div></div>
            <div class="h-stat"><div class="h-stat-label">LPå¥–åŠ±(ä¼°)</div><div class="h-stat-value">${fmtUSD(lpRewards)}</div></div>
        </div></div>
    `;
}

function renderBar(data) {
    const colors = ['#06b6d4','#8b5cf6','#10b981','#f59e0b','#ec4899','#3b82f6','#6b7280'];
    const max = Math.max(...data.map(d=>d.p), 1);
    return data.map((d,i)=>`<div class="bar-item"><span class="bar-label">${d.l}</span><div class="bar-container"><div class="bar-fill" style="width:${Math.max(d.p/max*100,2)}%;background:${colors[i%7]}"><span class="bar-pct">${d.p.toFixed(1)}%</span></div></div><span class="bar-value">${d.v}</span></div>`).join('');
}

// ============ æ¸²æŸ“å¸‚åœºåˆ—è¡¨ ============
function renderMarketsPage() {
    const cats = [...new Set(allMarkets.map(m=>m.category))].sort();
    
    document.getElementById('markets').innerHTML = `
        <div class="filters"><div class="filters-grid">
            <div class="filter-group"><label>ç±»å‹</label><select id="f-cat" onchange="filterMarkets()"><option value="All">å…¨éƒ¨</option>${cats.map(c=>`<option value="${c}">${getIcon(c)} ${c}</option>`).join('')}</select></div>
            <div class="filter-group"><label>çŠ¶æ€</label><select id="f-status" onchange="filterMarkets()"><option value="All">å…¨éƒ¨</option><option value="active">è¿›è¡Œä¸­</option><option value="closed">å·²ç»“ç®—</option></select></div>
            <div class="filter-group"><label>æ’åº</label><select id="f-sort" onchange="filterMarkets()"><option value="v24-desc">24hæˆäº¤â†“</option><option value="vol-desc">æ€»æˆäº¤â†“</option><option value="liq-desc">æµåŠ¨æ€§â†“</option><option value="spread-asc">ç£¨æŸâ†‘</option><option value="spread-desc">ç£¨æŸâ†“</option></select></div>
            <div class="filter-group"><label>æœ€ä½æµåŠ¨æ€§</label><select id="f-liq" onchange="filterMarkets()"><option value="0">å…¨éƒ¨</option><option value="1000">$1K+</option><option value="10000">$10K+</option><option value="100000">$100K+</option></select></div>
            <div class="filter-group"><label>ç£¨æŸç­›é€‰</label><select id="f-spread" onchange="filterMarkets()"><option value="all">å…¨éƒ¨</option><option value="profit">å¥—åˆ©æœºä¼š(<0)</option><option value="low">ä½ç£¨æŸ(<2%)</option><option value="high">é«˜ç£¨æŸ(>5%)</option></select></div>
            <div class="filter-group"><label>æœç´¢</label><input id="f-search" placeholder="å…³é”®è¯..." oninput="filterMarkets()"></div>
        </div></div>
        <div class="results-info">
            <div class="results-count">æ‰¾åˆ° <span id="mkt-cnt">0</span> ä¸ªå¸‚åœºï¼ˆå…± <span>${allMarkets.length}</span> ä¸ªï¼‰</div>
            <button class="refresh-btn" onclick="loadAllData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        </div>
        <div class="table-container"><div class="table-scroll"><table><thead><tr>
            <th>#</th><th>å¸‚åœº</th><th>ç±»å‹</th><th>çŠ¶æ€</th><th class="right">Yes</th><th class="right">No</th><th class="right">åˆè®¡</th><th class="right">ç£¨æŸ/å¥—åˆ©</th><th class="right">æµåŠ¨æ€§</th><th class="right">24hæˆäº¤</th><th class="right">æ€»æˆäº¤</th><th class="right">ç»“æŸæ—¥æœŸ</th>
        </tr></thead><tbody id="mkt-body"></tbody></table></div></div>
        <div class="pagination" id="pag"></div>
    `;
    
    filterMarkets();
}

function filterMarkets() {
    const cat = document.getElementById('f-cat').value;
    const status = document.getElementById('f-status').value;
    const sort = document.getElementById('f-sort').value;
    const minLiq = +document.getElementById('f-liq').value || 0;
    const spreadFilter = document.getElementById('f-spread').value;
    const search = document.getElementById('f-search').value.toLowerCase();
    
    filteredMarkets = allMarkets.filter(m => {
        if (cat !== 'All' && m.category !== cat) return false;
        if (status === 'active' && !m.active) return false;
        if (status === 'closed' && m.active) return false;
        if (m.liquidity < minLiq) return false;
        if (spreadFilter === 'profit' && m.spread >= 0) return false;
        if (spreadFilter === 'low' && m.spread >= 2) return false;
        if (spreadFilter === 'high' && m.spread < 5) return false;
        if (search && !m.title.toLowerCase().includes(search)) return false;
        return true;
    });
    
    const [f, o] = sort.split('-');
    const key = {v24:'volume24h',vol:'volume',liq:'liquidity',spread:'spread'}[f];
    filteredMarkets.sort((a,b) => o === 'asc' ? a[key] - b[key] : b[key] - a[key]);
    
    page = 1;
    renderTable();
}

function renderTable() {
    const start = (page-1) * pageSize;
    const rows = filteredMarkets.slice(start, start + pageSize);
    
    document.getElementById('mkt-body').innerHTML = rows.map((m,i) => {
        // ç£¨æŸæ ·å¼
        let sc = 'zero';
        if (m.spread < 0) sc = 'profit';
        else if (m.spread < 2) sc = 'low';
        else if (m.spread >= 5) sc = 'high';
        else sc = 'low';
        
        const yc = m.priceYes > 50 ? 'high' : m.priceYes < 50 ? 'low' : 'mid';
        const nc = m.priceNo > 50 ? 'high' : m.priceNo < 50 ? 'low' : 'mid';
        
        return `<tr>
            <td style="color:#6b7280">${start+i+1}</td>
            <td><div class="market-title"><span class="market-icon">${getIcon(m.category)}</span><span class="market-name" title="${m.title}">${m.title}</span></div></td>
            <td><span class="category-tag">${m.category}</span></td>
            <td><span class="status-tag ${m.active?'active':'ended'}">${m.active?'è¿›è¡Œä¸­':'å·²ç»“ç®—'}</span></td>
            <td class="mono"><span class="price ${yc}">${m.priceYes.toFixed(1)}%</span></td>
            <td class="mono"><span class="price ${nc}">${m.priceNo.toFixed(1)}%</span></td>
            <td class="mono">${m.totalPrice.toFixed(1)}%</td>
            <td class="mono"><span class="spread ${sc}">${m.spread >= 0 ? '+' : ''}${m.spread.toFixed(2)}%</span></td>
            <td class="mono">${fmtUSD(m.liquidity)}</td>
            <td class="mono">${fmtUSD(m.volume24h)}</td>
            <td class="mono">${fmtUSD(m.volume)}</td>
            <td style="color:#9ca3af;font-size:7px">${fmtDate(m.endDate)}</td>
        </tr>`;
    }).join('') || '<tr><td colspan="12" style="text-align:center;padding:20px;color:#6b7280;">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å¸‚åœº</td></tr>';
    
    document.getElementById('mkt-cnt').textContent = filteredMarkets.length;
    renderPagination();
}

function renderPagination() {
    const total = Math.ceil(filteredMarkets.length / pageSize);
    if (total <= 1) { document.getElementById('pag').innerHTML = ''; return; }
    let h = `<button ${page===1?'disabled':''} onclick="goPage(${page-1})">ä¸Šä¸€é¡µ</button>`;
    const start = Math.max(1, page - 4);
    const end = Math.min(total, start + 9);
    for (let i = start; i <= end; i++) h += `<button class="${page===i?'active':''}" onclick="goPage(${i})">${i}</button>`;
    if (end < total) h += `<span style="color:#6b7280;padding:0 3px">...${total}</span>`;
    h += `<button ${page===total?'disabled':''} onclick="goPage(${page+1})">ä¸‹ä¸€é¡µ</button>`;
    document.getElementById('pag').innerHTML = h;
}

function goPage(p) { page = p; renderTable(); }

// ============ æ¸²æŸ“ç”¨æˆ·åˆ†æ ============
function renderUsersPage() {
    const S = marketStats;
    const catStats = S.categoryStats || {};
    
    // ç±»åˆ«å‚ä¸åº¦
    const catArr = Object.entries(catStats)
        .map(([name, data]) => ({ name, icon: getIcon(name), ...data }))
        .sort((a, b) => b.volume - a.volume);
    
    document.getElementById('users').innerHTML = `
        <div class="info-box info">
            ğŸ“Š ç”¨æˆ·åˆ†æåŸºäº API è¿”å›çš„ <strong>${S.totalMarkets}</strong> ä¸ªå¸‚åœºæ•°æ®ç»Ÿè®¡ï¼Œå…¶ä¸­ <strong>${S.activeMarkets}</strong> ä¸ªæ´»è·ƒå¸‚åœºã€‚
            æ›´è¯¦ç»†çš„ç”¨æˆ·æ•°æ®è¯·ä½¿ç”¨ä¸‹æ–¹"åœ°å€æŸ¥è¯¢"åŠŸèƒ½æŸ¥è¯¢å…·ä½“åœ°å€ã€‚
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-label">æ€»å¸‚åœºæ•°</div><div class="stat-value">${fmt(S.totalMarkets)}</div></div>
            <div class="stat-card green"><div class="stat-label">æ´»è·ƒå¸‚åœº</div><div class="stat-value">${fmt(S.activeMarkets)}</div></div>
            <div class="stat-card orange"><div class="stat-label">æ€»æˆäº¤é‡</div><div class="stat-value">${fmtUSD(S.totalVolume)}</div></div>
            <div class="stat-card purple"><div class="stat-label">å¹³å°TVL</div><div class="stat-value">${fmtUSD(S.totalLiquidity)}</div></div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px;">
            <div class="section"><div class="section-title">ğŸ“Š ç±»åˆ«æˆäº¤é‡å æ¯”</div><div class="bar-chart">${renderBar(catArr.map(d=>({l:`${d.icon} ${d.name}`,v:fmtUSD(d.volume),p:d.volume/S.totalVolume*100})))}</div></div>
            <div class="section"><div class="section-title">ğŸ’§ ç±»åˆ«æµåŠ¨æ€§åˆ†å¸ƒ</div><div class="bar-chart">${renderBar(catArr.map(d=>({l:`${d.icon} ${d.name}`,v:fmtUSD(d.liquidity),p:d.liquidity/S.totalLiquidity*100})))}</div></div>
            <div class="section"><div class="section-title">ğŸ“ˆ ç£¨æŸåˆ†å¸ƒ</div><div class="bar-chart">${renderBar([
                {l:'å¥—åˆ©æœºä¼š(<0%)',v:fmt(S.spreadDistribution?.negative||0),p:(S.spreadDistribution?.negative||0)/S.activeMarkets*100},
                {l:'æ— ç£¨æŸ(0-0.5%)',v:fmt(S.spreadDistribution?.zero||0),p:(S.spreadDistribution?.zero||0)/S.activeMarkets*100},
                {l:'ä½ç£¨æŸ(0.5-2%)',v:fmt(S.spreadDistribution?.low||0),p:(S.spreadDistribution?.low||0)/S.activeMarkets*100},
                {l:'ä¸­ç£¨æŸ(2-5%)',v:fmt(S.spreadDistribution?.medium||0),p:(S.spreadDistribution?.medium||0)/S.activeMarkets*100},
                {l:'é«˜ç£¨æŸ(>5%)',v:fmt(S.spreadDistribution?.high||0),p:(S.spreadDistribution?.high||0)/S.activeMarkets*100}
            ])}</div></div>
            <div class="section"><div class="section-title">ğŸ“Š å¸‚åœºç»Ÿè®¡æŒ‡æ ‡</div><div class="h-stats">
                <div class="h-stat"><div class="h-stat-label">å¹³å‡æˆäº¤é‡</div><div class="h-stat-value">${fmtUSD(S.totalVolume/S.totalMarkets)}</div></div>
                <div class="h-stat"><div class="h-stat-label">å¹³å‡æµåŠ¨æ€§</div><div class="h-stat-value">${fmtUSD(S.totalLiquidity/S.activeMarkets)}</div></div>
                <div class="h-stat"><div class="h-stat-label">å¹³å‡ç£¨æŸ</div><div class="h-stat-value">${S.avgSpread.toFixed(2)}%</div></div>
                <div class="h-stat"><div class="h-stat-label">å¥—åˆ©æœºä¼šæ•°</div><div class="h-stat-value green">${fmt(S.spreadDistribution?.negative||0)}</div></div>
                <div class="h-stat"><div class="h-stat-label">é«˜ç£¨æŸå¸‚åœº</div><div class="h-stat-value red">${fmt(S.spreadDistribution?.high||0)}</div></div>
                <div class="h-stat"><div class="h-stat-label">24hå‡æˆäº¤</div><div class="h-stat-value">${fmtUSD(S.volume24h/S.activeMarkets)}</div></div>
            </div></div>
        </div>
        
        <div class="section"><div class="section-title">ğŸ’¡ æç¤º</div>
            <p style="font-size:9px;color:#9ca3af;line-height:1.5;">
                è¦æŸ¥çœ‹å…·ä½“ç”¨æˆ·çš„æŒä»“ã€äº¤æ˜“å†å²ã€ç›ˆäºç­‰æ•°æ®ï¼Œè¯·ä½¿ç”¨"åœ°å€æŸ¥è¯¢"åŠŸèƒ½ã€‚<br>
                è¾“å…¥ç”¨æˆ·çš„ Polymarket é’±åŒ…åœ°å€ï¼ˆ0x...ï¼‰å³å¯è·å–å®Œæ•´çš„äº¤æ˜“ç»Ÿè®¡å’ŒæŒä»“æ˜ç»†ã€‚
            </p>
        </div>
    `;
}

// ============ æ¸²æŸ“åœ°å€æŸ¥è¯¢ ============
function renderAddressPage() {
    document.getElementById('address').innerHTML = `
        <div class="lookup-container">
            <div class="section-title">ğŸ” åœ°å€æŸ¥è¯¢ (çœŸå®APIæ•°æ®)</div>
            <div class="lookup-form">
                <input class="lookup-input" id="addr-input" placeholder="è¾“å…¥ Polymarket é’±åŒ…åœ°å€ (0x...)" onkeypress="if(event.key==='Enter')lookupAddress()">
                <button class="lookup-btn" id="lookup-btn" onclick="lookupAddress()">æŸ¥è¯¢</button>
            </div>
            <div class="info-box info" id="lookup-info">è¾“å…¥åœ°å€åå°†ä» Polymarket API å’Œ Polygonscan è·å–çœŸå®äº¤æ˜“æ•°æ®å’ŒæŒä»“ä¿¡æ¯</div>
            <div class="empty-state" id="empty-state">
                <p style="font-size:11px;margin-bottom:5px;">è¾“å…¥åœ°å€å¼€å§‹æŸ¥è¯¢</p>
                <p style="font-size:9px;">æ”¯æŒä»»æ„å‚ä¸è¿‡ Polymarket çš„ä»¥å¤ªåŠåœ°å€</p>
            </div>
            <div id="user-result"></div>
        </div>
    `;
}

async function lookupAddress() {
    const addr = document.getElementById('addr-input').value.trim();
    const info = document.getElementById('lookup-info');
    const btn = document.getElementById('lookup-btn');
    
    if (!addr.match(/^0x[a-fA-F0-9]{40}$/i)) {
        info.className = 'info-box warning';
        info.innerHTML = 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€ (0x + 40ä½)';
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="spin"></span>æŸ¥è¯¢ä¸­';
    info.className = 'info-box info';
    info.innerHTML = 'â³ æ­£åœ¨ä»APIè·å–å®Œæ•´æ•°æ®...';
    document.getElementById('empty-state').style.display = 'none';
    
    try {
        const response = await fetch(`/api/lookup?address=${addr}`);
        const data = await response.json();
        
        if (data.success) {
            const s = data.stats;
            const hasData = s.positionCount > 0 || s.totalTrades > 0;
            
            if (hasData) {
                info.className = 'info-box success';
                info.innerHTML = `âœ… æ•°æ®è·å–æˆåŠŸï¼æ‰¾åˆ° ${s.positionCount} ä¸ªæŒä»“ï¼Œ${s.totalTrades} æ¡äº¤æ˜“è®°å½•`;
            } else {
                info.className = 'info-box warning';
                info.innerHTML = `âš ï¸ è¯¥åœ°å€åœ¨APIä¸­æœªæ‰¾åˆ°äº¤æ˜“æ•°æ®ï¼Œå¯èƒ½æ˜¯æ–°åœ°å€æˆ–æœªå‚ä¸è¿‡äº¤æ˜“`;
            }
            
            renderUserResult(data);
        } else {
            throw new Error(data.error || 'æŸ¥è¯¢å¤±è´¥');
        }
    } catch (error) {
        info.className = 'info-box error';
        info.innerHTML = `âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`;
    }
    
    btn.disabled = false;
    btn.textContent = 'æŸ¥è¯¢';
}

function renderUserResult(data) {
    const s = data.stats;
    const result = document.getElementById('user-result');
    
    result.innerHTML = `
        <div class="user-header">
            <span class="user-avatar">ğŸ‘¤</span>
            <div style="flex:1"><div style="color:#9ca3af;font-size:7px">é’±åŒ…åœ°å€</div><div class="user-address">${data.address}</div></div>
            <div class="user-links">
                <a href="https://polymarket.com/profile/${data.address}" target="_blank">Polymarket â†—</a>
                <a href="https://polygonscan.com/address/${data.address}" target="_blank">Polygonscan â†—</a>
            </div>
        </div>
        
        <div class="user-stats-grid">
            <div class="user-stat-card"><div class="user-stat-label">USDCä½™é¢ (Polygonscan)</div><div class="user-stat-value" style="color:#10b981">${fmtUSD(s.usdcBalance)}</div></div>
            <div class="user-stat-card"><div class="user-stat-label">Portfolioä»·å€¼</div><div class="user-stat-value">${fmtUSD(s.portfolioValue)}</div></div>
            <div class="user-stat-card"><div class="user-stat-label">æŠ•å…¥é‡‘é¢</div><div class="user-stat-value" style="color:#06b6d4">${fmtUSD(s.investedAmount)}</div></div>
            <div class="user-stat-card"><div class="user-stat-label">æœªå®ç°ç›ˆäº</div><div class="user-stat-value" style="color:${s.unrealizedPnl>=0?'#10b981':'#ef4444'}">${s.unrealizedPnl>=0?'+':''}${fmtUSD(s.unrealizedPnl)}</div></div>
            <div class="user-stat-card"><div class="user-stat-label">å·²å®ç°ç›ˆäº</div><div class="user-stat-value" style="color:${s.realizedPnl>=0?'#10b981':'#ef4444'}">${s.realizedPnl>=0?'+':''}${fmtUSD(s.realizedPnl)}</div></div>
            <div class="user-stat-card"><div class="user-stat-label">æ€»æˆäº¤é‡</div><div class="user-stat-value" style="color:#8b5cf6">${fmtUSD(s.totalVolume)}</div></div>
        </div>
        
        <div class="section"><div class="section-title">ğŸ“Š äº¤æ˜“ç»Ÿè®¡</div><div class="h-stats">
            <div class="h-stat"><div class="h-stat-label">æ€»äº¤æ˜“æ¬¡æ•°</div><div class="h-stat-value">${fmt(s.totalTrades)}</div></div>
            <div class="h-stat"><div class="h-stat-label">ä¹°å…¥æ¬¡æ•°</div><div class="h-stat-value green">${fmt(s.buyCount)}</div></div>
            <div class="h-stat"><div class="h-stat-label">å–å‡ºæ¬¡æ•°</div><div class="h-stat-value red">${fmt(s.sellCount)}</div></div>
            <div class="h-stat"><div class="h-stat-label">ä¹°å…¥é‡‘é¢</div><div class="h-stat-value">${fmtUSD(s.totalBuyVolume)}</div></div>
            <div class="h-stat"><div class="h-stat-label">å–å‡ºé‡‘é¢</div><div class="h-stat-value">${fmtUSD(s.totalSellVolume)}</div></div>
            <div class="h-stat"><div class="h-stat-label">å‚ä¸å¸‚åœº</div><div class="h-stat-value">${fmt(s.marketsParticipated)}</div></div>
            <div class="h-stat"><div class="h-stat-label">æ´»è·ƒå¤©æ•°</div><div class="h-stat-value">${fmt(s.activeDays)}</div></div>
            <div class="h-stat"><div class="h-stat-label">LPå¥–åŠ±(ä¼°)</div><div class="h-stat-value">${fmtUSD(s.estimatedLpRewards)}</div></div>
        </div></div>
        
        <div class="section"><div class="section-title">ğŸ’¼ æŒä»“ç»Ÿè®¡</div><div class="h-stats">
            <div class="h-stat"><div class="h-stat-label">å½“å‰æŒä»“</div><div class="h-stat-value">${fmt(s.positionCount)}</div></div>
            <div class="h-stat"><div class="h-stat-label">ç›ˆåˆ©æ ‡çš„</div><div class="h-stat-value green">${fmt(s.winningPositions)}</div></div>
            <div class="h-stat"><div class="h-stat-label">äºæŸæ ‡çš„</div><div class="h-stat-value red">${fmt(s.losingPositions)}</div></div>
            <div class="h-stat"><div class="h-stat-label">æŒå¹³</div><div class="h-stat-value">${fmt(s.neutralPositions)}</div></div>
            <div class="h-stat"><div class="h-stat-label">èƒœç‡</div><div class="h-stat-value">${s.winRate.toFixed(1)}%</div></div>
            <div class="h-stat"><div class="h-stat-label">é¦–æ¬¡äº¤æ˜“</div><div class="h-stat-value" style="font-size:7px">${s.firstTradeDate ? fmtDate(s.firstTradeDate) : '-'}</div></div>
        </div></div>
        
        ${data.positions && data.positions.length > 0 ? `
        <div class="history-section">
            <div class="history-title"><span>ğŸ“‹ æŒä»“æ˜ç»†</span><span>${data.positions.length} ä¸ª</span></div>
            ${data.positions.slice(0, 20).map(p => {
                const cv = parseFloat(p.currentValue) || 0;
                const iv = parseFloat(p.initialValue) || parseFloat(p.cost) || 0;
                const pnl = cv - iv;
                const pnlPct = iv > 0 ? (pnl/iv*100).toFixed(1) : '0';
                return `<div class="position-item">
                    <div class="position-left">
                        <span class="position-outcome ${(p.outcome||'Yes').toLowerCase()}">${p.outcome||'Yes'}</span>
                        <span class="position-market">${p.title||p.marketSlug||p.market||'Unknown'}</span>
                    </div>
                    <div class="position-right">
                        <div class="position-data"><div class="position-data-label">æŠ•å…¥</div><div class="position-data-value">${fmtUSD(iv)}</div></div>
                        <div class="position-data"><div class="position-data-label">ç°å€¼</div><div class="position-data-value">${fmtUSD(cv)}</div></div>
                        <div class="position-data"><div class="position-data-label">ç›ˆäº</div><div class="position-data-value ${pnl>=0?'green':'red'}">${pnl>=0?'+':''}${pnlPct}%</div></div>
                    </div>
                </div>`;
            }).join('')}
            ${data.positions.length > 20 ? `<div style="text-align:center;padding:6px;color:#6b7280;font-size:8px;">è¿˜æœ‰ ${data.positions.length - 20} ä¸ªæŒä»“</div>` : ''}
        </div>
        ` : ''}
        
        ${data.history && data.history.length > 0 ? `
        <div class="history-section">
            <div class="history-title"><span>ğŸ“œ äº¤æ˜“å†å²</span><span>æœ€è¿‘ ${Math.min(data.history.length, 50)} æ¡</span></div>
            ${data.history.slice(0, 50).map(h => {
                const type = (h.type || h.side || '').toLowerCase();
                const isBuy = type === 'buy' || type === 'b';
                const value = Math.abs(parseFloat(h.value) || parseFloat(h.amount) || 0);
                return `<div class="history-item">
                    <span class="history-type ${isBuy?'buy':'sell'}">${isBuy?'ä¹°å…¥':'å–å‡º'}</span>
                    <span class="history-market">${h.title||h.marketSlug||h.market||'Unknown'}</span>
                    <div class="history-data">
                        <span class="history-amount">${fmtUSD(value)}</span>
                        <span class="history-date">${h.timestamp ? fmtDateTime(h.timestamp) : ''}</span>
                    </div>
                </div>`;
            }).join('')}
            ${data.history.length > 50 ? `<div style="text-align:center;padding:6px;color:#6b7280;font-size:8px;">è¿˜æœ‰ ${data.history.length - 50} æ¡è®°å½•</div>` : ''}
        </div>
        ` : '<div class="history-section"><div style="text-align:center;padding:15px;color:#6b7280;font-size:9px;">æš‚æ— äº¤æ˜“å†å²</div></div>'}
    `;
}

function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    event.target.classList.add('active');
}

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', loadAllData);
    </script>
</body>
</html>
